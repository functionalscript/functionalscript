import { utf8 } from "../../text/module.f.ts"
import type { Array3, Array4 } from "../../types/array/module.f.ts"
import { empty, msb, repeat, vec, vec8, type Vec } from "../../types/bit_vec/module.f.ts"
import { hmac } from "../hmac/module.f.ts"
import { curve, secp192r1, secp256r1, secp384r1, secp521r1, type Curve } from "../secp/module.f.ts"
import { computeSync, sha224, sha256, sha384, sha512, type Sha2 } from "../sha2/module.f.ts"
import { all, concat, computeK, fromCurve, sign } from "./module.f.ts"

const sample = utf8("sample")
const test = utf8("test")

const x00 = vec8(0x00n)
const x01 = vec8(0x01n)

const v168 = vec(168n)
const v256 = vec(256n)
const v600 = vec(600n)
const r32 = repeat(32n)
const hmac256 = hmac(sha256)

export default {
    bits2int: () => {
        if (all(7n).bits2int(vec(5n)(0b10100n)) !== 0b101n) { throw new Error("fail") }
        if (all(17n).bits2int(vec(3n)(0b101n)) !== 0b101n) { throw new Error("fail") }
    },
    int2octets: () => {
        // 3 bit prime
        if (all(5n).int2octets(0b101n) !== vec(8n)(0b0000_0101n)) { throw new Error("fail") }
        // 5 bit prime
        if (all(17n).int2octets(0b10100n) !== vec(8n)(0b0001_0100n)) { throw new Error("fail") }
        // 15 bit prime
        if (all(16387n).int2octets(0x13n) !== vec(16n)(0x13n)) { throw new Error("fail") }
    },
    bit2octets: () => {
        if (all(11n).bits2octets(vec(4n)(0b1101n)) !== vec(8n)(0b0000_0010n)) { throw new Error("fail") }
    },
    k: () => {
        //
        const q = 0x4000000000000000000020108A2E0CC0D99F8A5EFn
        const { qlen, int2octets, bits2octets, bits2int } = all(q)
        if (qlen !== 163n) { throw qlen }
        const x = 0x09A4D6792295A7F730FC3F2B49CBC0F62E862272Fn
        const h1 = computeSync(sha256)([sample])
        if (h1 !== v256(0xAF2BDBE1AA9B6EC1E2ADE1D694F41FC71A831D0268E9891562113D8A62ADD1BFn)) { throw h1 }
        const xi2o = int2octets(x)
        if (xi2o !== v168(0x009A4D6792295A7F730FC3F2B49CBC0F62E862272Fn)) { throw xi2o }
        const h1b2o = bits2octets(h1)
        if (h1b2o !== v168(0x01795EDF0D54DB760F156D0DAC04C0322B3A204224n)) { throw h1b2o }
        let v = r32(x01)
        if (v !== v256(0x0101010101010101010101010101010101010101010101010101010101010101n)) { throw v }
        let k = r32(x00)
        if (k !== v256(0x0000000000000000000000000000000000000000000000000000000000000000n)) { throw k }
        // d.
        // 256 + 8 + 168 + 168 = 600
        const vv = concat(v, x00, xi2o, h1b2o)
        const vvu =
            0x0101010101010101010101010101010101010101010101010101010101010101_00_009A4D6792295A7F730FC3F2B49CBC0F62E862272F_01795EDF0D54DB760F156D0DAC04C0322B3A204224n
        if (vv !== v600(vvu)) { throw [(vv as any).toString(16), vvu.toString(16)] }
        k = hmac256(k)(vv)
        if (k !== v256(0x09999A9BFEF972D3346911883FAD7951D23F2C8B47F420222D1171EEEEAC5AB8n)) { throw k }
        // e.
        v = hmac256(k)(v)
        if (v !== v256(0xD5F4030F755EE86AA10BBA8C09DF114FF6B6111C238500D13C7343A8C01BECF7n)) { throw v }
        // f. K = HMAC_K(V || 0x01 || int2octets(x) || bits2octets(h1))
        k = hmac256(k)(concat(v, x01, xi2o, h1b2o))
        if (k !== v256(0x0CF2FE96D5619C9EF53CB7417D49D37EA68A4FFED0D7E623E38689289911BD57n)) { throw k }
        // g.
        v = hmac256(k)(v)
        if (v !== v256(0x783457C1CF3148A8F2A9AE73ED472FA98ED9CD925D8E964CE0764DEF3F842B9An)) { throw v }
        // h.
        v = hmac256(k)(v)
        let t = msb.concat(empty)(v)
        if (t !== v256(0x9305A46DE7FF8EB107194DEBD3FD48AA20D5E7656CBE0EA69D2A8D4E7C67314An)) { throw t }
        // 3.
        let kk = bits2int(t)
        if (kk !== 0x4982D236F3FFC758838CA6F5E9FEA455106AF3B2Bn) { throw kk }
        // 3. second try
        k = hmac256(k)(concat(v, x00))
        if (k !== v256(0x75CB5C05B2A78C3D81DF12D74D7BE0A0E94AB19815781D4D8E2902A79D0A6699n)) { throw k }
        v = hmac256(k)(v)
        if (v !== v256(0xDCB9CA126107A9C27CE77BA58EA871C8C912D835EADDC305F2445D88F66C4C43n)) { throw v }
        v = hmac256(k)(v)
        t = msb.concat(empty)(v)
        if (t !== v256(0xC70C78608A3B5BE9289BE90EF6E81A9E2C1516D5751D2F75F50033E45F73BDEBn)) { throw t }
        kk = bits2int(t)
        if (kk !== 0x63863C30451DADF4944DF4877B740D4F160A8B6ABn) { throw kk }
        // 3. third try
        k = hmac256(k)(concat(v, x00))
        if (k !== v256(0x0A5A64B99C059520103686CB6F36BCFCA788EB3BCF69BA66A5BB080B0593BA53n)) { throw k }
        v = hmac256(k)(v)
        if (v !== v256(0x0B3B196811B19F6C6F729C43F35BCF0DFD725F17CA3430E8721453E55550A18Fn)) { throw v }
        v = hmac256(k)(v)
        t = msb.concat(empty)(v)
        if (t !== v256(0x475E80E992140567FCC3A50DAB90FE84BCD7BB03638E9C4656A06F37F6508A7Cn)) { throw t }
        kk = bits2int(t)
        if (kk !== 0x23AF4074C90A02B3FE61D286D5C87F425E6BDD81Bn) { throw kk }
    },
    computeK: () => {
        const q = 0x4000000000000000000020108A2E0CC0D99F8A5EFn
        const a = all(q)
        if (a.qlen !== 163n) { throw a.qlen }
        const x = 0x09A4D6792295A7F730FC3F2B49CBC0F62E862272Fn
        const k = computeK(a)(sha256)(x)(sample)
        if (k !== 0x23AF4074C90A02B3FE61D286D5C87F425E6BDD81Bn) { throw k }
    },
    investigate: () => {
        const q = 0xF2C3119374CE76C9356990B465374A17F23F9ED35089BD969F61C6DDE9998C1Fn
        const x = 0x69C7548C21D0DFEA6B9A51C9EAD4E27C33D3B3F180316E5BCAB92C933F0E4DBCn
        const a = all(q)
        const k = computeK(a)(sha384)(x)(sample)
        if (k !== 0xC345D5AB3DA0A5BCB7EC8F8FB7A7E96069E03B206371EF7D83E39068EC564920n) { throw k }
    },
    kk: () => {
        const a = fromCurve(secp192r1)
        const x = 0x6FAB034934E4C0FC9AE67F5B5659A9D7D1FEFD187EE09FD4n
        const m = utf8("sample")
        const kk = computeK(a)(sha224)(x)(m)
        if (kk !== 0x4381526B3FC1E7128F202E194505592F01D5FF4C5AF015D8n) { throw kk }
    },
    a2: () =>{
        type H = Array4<bigint>
        type P = {
            readonly q: bigint
            readonly x: bigint
            readonly msg0: H
            readonly msg1: H
        }
        type S = { readonly [key: string]: P }
        const check = ({ q, x, msg0, msg1 }: P) => {
            const a = all(q)
            const check = (sha: Sha2, expected: bigint, m: Vec) => {
                const k = computeK(a)(sha)(x)(m)
                if (k !== expected) { throw [k.toString(16), expected.toString(16)] }
            }
            const check4 = (m: Vec, h: H) => {
                check(sha224, h[0], m)
                check(sha256, h[1], m)
                check(sha384, h[2], m)
                check(sha512, h[3], m)
            }
            check4(sample, msg0)
            check4(test, msg1)
        }
        const testVectors: S = {
            x1: {
                q: 0x996F967F6C8E388D9E28D01E205FBA957A5698B1n,
                x: 0x411602CB19A6CCC34494D79D98EF1E7ED5AF25F7n,
                msg0: [
                    0x562097C06782D60C3037BA7BE104774344687649n,
                    0x519BA0546D0C39202A7D34D7DFA5E760B318BCFBn,
                    0x95897CD7BBB944AA932DBC579C1C09EB6FCFC595n,
                    0x09ECE7CA27D0F5A4DD4E556C9DF1D21D28104F8Bn
                ],
                msg1: [
                    0x4598B8EFC1A53BC8AECD58D1ABBB0C0C71E67297n,
                    0x5A67592E8128E03A417B0484410FB72C0B630E1An,
                    0x220156B761F6CA5E6C9F1B9CF9C24BE25F98CD89n,
                    0x65D2C2EEB175E370F28C75BFCDC028D22C7DBE9Cn
                ]
            },
            x3: {
                q: 0xFFFFFFFFFFFFFFFFFFFFFFFF99DEF836146BC9B1B4D22831n,
                x: 0x6FAB034934E4C0FC9AE67F5B5659A9D7D1FEFD187EE09FD4n,
                msg0: [
                    0x4381526B3FC1E7128F202E194505592F01D5FF4C5AF015D8n,
                    0x32B1B6D7D42A05CB449065727A84804FB1A3E34D8F261496n,
                    0x4730005C4FCB01834C063A7B6760096DBE284B8252EF4311n,
                    0xA2AC7AB055E4F20692D49209544C203A7D1F2C0BFBC75DB1n
                ],
                msg1: [
                    0xF5DC805F76EF851800700CCE82E7B98D8911B7D510059FBEn,
                    0x5C4CE89CF56D9E7C77C8585339B006B97B5F0680B4306C6Cn,
                    0x5AFEFB5D3393261B828DB6C91FBC68C230727B030C975693n,
                    0x0758753A5254759C7CFBAD2E2D9B0792EEE44136C9480527n,
                ],
            },
            x4: {
                q: 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFF16A2E0B8F03E13DD29455C5C2A3Dn,
                x: 0xF220266E1105BFE3083E03EC7A3A654651F45E37167E88600BF257C1n,
                msg0: [
                    0xC1D1F2F10881088301880506805FEB4825FE09ACB6816C36991AA06Dn,
                    0xAD3029E0278F80643DE33917CE6908C70A8FF50A411F06E41DEDFCDCn,
                    0x52B40F5A9D3D13040F494E83D3906C6079F29981035C7BD51E5CAC40n,
                    0x9DB103FFEDEDF9CFDBA05184F925400C1653B8501BAB89CEA0FBEC14n,
                ],
                msg1: [
                    0xDF8B38D40DCA3E077D0AC520BF56B6D565134D9B5F2EAE0D34900524n,
                    0xFF86F57924DA248D6E44E8154EB69F0AE2AEBAEE9931D0B5A969F904n,
                    0x7046742B839478C1B5BD31DB2E862AD868E1A45C863585B5F22BDC2Dn,
                    0xE39C2AA4EA6BE2306C72126D40ED77BF9739BB4D6EF2BBB1DCB6169Dn,
                ],
            },
            x8: {
                q: 0x4000000000000000000020108A2E0CC0D99F8A5EFn,
                x: 0x09A4D6792295A7F730FC3F2B49CBC0F62E862272Fn,
                msg0: [
                    0x323E7B28BFD64E6082F5B12110AA87BC0D6A6E159n,
                    0x23AF4074C90A02B3FE61D286D5C87F425E6BDD81Bn,
                    0x2132ABE0ED518487D3E4FA7FD24F8BED1F29CCFCEn,
                    0x00BBCC2F39939388FDFE841892537EC7B1FF33AA3n,
                ],
                msg1: [
                    0x091DD986F38EB936BE053DD6ACE3419D2642ADE8Dn,
                    0x193649CE51F0CFF0784CFC47628F4FA854A93F7A2n,
                    0x37C73C6F8B404EC83DA17A6EBCA724B3FF1F7EEBAn,
                    0x331AD98D3186F73967B1E0B120C80B1E22EFC2988n,
                ],
            },
            x9: {
                q: 0x8000000000000000000000000000069D5BB915BCD46EFB1AD5F173ABDFn,
                x: 0x103B2142BDC2A3C3B55080D09DF1808F79336DA2399F5CA7171D1BE9B0n,
                msg0: [
                    0x71626A309D9CD80AD0B975D757FE6BF4B84E49F8F34C780070D7746F19n,
                    0x73552F9CAC5774F74F485FA253871F2109A0C86040552EAA67DBA92DC9n,
                    0x17D726A67539C609BD99E29AA3737EF247724B71455C3B6310034038C8n,
                    0x0E535C328774CDE546BE3AF5D7FCD263872F107E807435105BA2FDC166n,
                ],
                msg1: [
                    0x67634D0ABA2C9BF7AE54846F26DCD166E7100654BCE6FDC96667631AA2n,
                    0x2CE5AEDC155ACC0DDC5E679EBACFD21308362E5EFC05C5E99B2557A8D7n,
                    0x1B4BD3903E74FD0B31E23F956C70062014DFEFEE21832032EA5352A055n,
                    0x1775ED919CA491B5B014C5D5E86AF53578B5A7976378F192AF665CB705n,
                ],
            },
            x10: {
                q: 0x1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE9AE2ED07577265DFF7F94451E061E163C61n,
                x: 0x06A0777356E87B89BA1ED3A3D845357BE332173C8F7A65BDC7DB4FAB3C4CC79ACC8194En,
                msg0: [
                    0x1B4C4E3B2F6B08B5991BD2BDDE277A7016DA527AD0AAE5BC61B64C5A0EE63E8B502EF61n,
                    0x1CEB9E8E0DFF53CE687DEB81339ACA3C98E7A657D5A9499EF779F887A934408ECBE5A38n,
                    0x1460A5C41745A5763A9D548AE62F2C3630BBED71B6AA549D7F829C22442A728C5D965DAn,
                    0x00F3B59FCB5C1A01A1A2A0019E98C244DFF61502D6E6B9C4E957EDDCEB258EF4DBEF04An,
                ],
                msg1: [
                    0x045E13EA645CE01D9B25EA38C8A8A170E04C83BB7F231EE3152209FE10EC8B2E565536Cn,
                    0x0B585A7A68F51089691D6EDE2B43FC4451F66C10E65F134B963D4CBD4EB844B0E1469A6n,
                    0x1E88738E14482A09EE16A73D490A7FE8739DF500039538D5C4B6C8D6D7F208D6CA56760n,
                    0x00E5F24A223BD459653F682763C3BB322D4EE75DD89C63D4DC61518D543E76585076BBAn,
                ],
            },
            x11: {
                q: 0x7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE5F83B2D4EA20400EC4557D5ED3E3E7CA5B4B5C83B8E01E5FCFn,
                x: 0x29C16768F01D1B8A89FDA85E2EFD73A09558B92A178A2931F359E4D70AD853E569CDAF16DAA569758FB4E73089E4525D8BBFCFn,
                msg0: [
                    0x512340DB682C7B8EBE407BF1AA54194DFE85D49025FE0F632C9B8A06A996F2FCD0D73C752FB09D23DB8FBE50605DC25DF0745Cn,
                    0x782385F18BAF5A36A588637A76DFAB05739A14163BF723A4417B74BD1469D37AC9E8CCE6AEC8FF63F37B815AAF14A876EED962n,
                    0x4DA637CB2E5C90E486744E45A73935DD698D4597E736DA332A06EDA8B26D5ABC6153EC2ECE14981CF3E5E023F36FFA55EEA6D7n,
                    0x57055B293ECFDFE983CEF716166091E573275C53906A39EADC25C89C5EC8D7A7E5629FCFDFAD514E1348161C9A34EA1C42D58Cn,
                ],
                msg1: [
                    0x3C5352929D4EBE3CCE87A2DCE380F0D2B33C901E61ABC530DAF3506544AB0930AB9BFD553E51FCDA44F06CD2F49E17E07DB519n,
                    0x251E32DEE10ED5EA4AD7370DF3EFF091E467D5531CA59DE3AA791763715E1169AB5E18C2A11CD473B0044FB45308E8542F2EB0n,
                    0x11C540EA46C5038FE28BB66E2E9E9A04C9FE9567ADF33D56745953D44C1DC8B5B92922F53A174E431C0ED8267D919329F19014n,
                    0x59527CE953BC09DF5E85155CAE7BB1D7F342265F41635545B06044F844ECB4FA6476E7D47420ADC8041E75460EC0A4EC760E95n,
                ],
            },
            x12: {
                q: 0x20000000000000000000000000000000000000000000000000000000000000000000000131850E1F19A63E4B391A8DB917F4138B630D84BE5D639381E91DEB45CFE778F637C1001n,
                x: 0x0C16F58550D824ED7B95569D4445375D3A490BC7E0194C41A39DEB732C29396CDF1D66DE02DD1460A816606F3BEC0F32202C7BD18A32D87506466AA92032F1314ED7B19762B0D22n,
                msg0: [
                    0x0B599D068A1A00498EE0B9AD6F388521F594BD3F234E47F7A1DB6490D7B57D60B0101B36F39CC22885F78641C69411279706F0989E6991E5D5B53619E43EFB397E25E0814EF02BCn,
                    0x0F79D53E63D89FB87F4D9E6DC5949F5D9388BCFE9EBCB4C2F7CE497814CF40E845705F8F18DBF0F860DE0B1CC4A433EF74A5741F3202E958C082E0B76E16ECD5866AA0F5F3DF300n,
                    0x0308253C022D25F8A9EBCD24459DD6596590BDEC7895618EEE8A2623A98D2A2B2E7594EE6B7AD3A39D70D68CB4ED01CB28E2129F8E2CC0CC8DC7780657E28BCD655F0BE9B7D35A2n,
                    0x0C5EE7070AF55F84EBC43A0D481458CEDE1DCEBB57720A3C92F59B4941A044FECFF4F703940F3121773595E880333772ACF822F2449E17C64DA286BCD65711DD5DA44D7155BF004n,
                ],
                msg1: [
                    0x1DA875065B9D94DBE75C61848D69578BCC267935792624F9887B53C9AF9E43CABFC42E4C3F9A456BA89E717D24F1412F33CFD297A7A4D403B18B5438654C74D592D5022125E0C6Bn,
                    0x04DDD0707E81BB56EA2D1D45D7FAFDBDD56912CAE224086802FEA1018DB306C4FB8D93338DBF6841CE6C6AB1506E9A848D2C0463E0889268843DEE4ACB552CFFCB858784ED116B2n,
                    0x0141B53DC6E569D8C0C0718A58A5714204502FDA146E7E2133E56D19E905B79413457437095DE13CF68B5CF5C54A1F2E198A55D974FC3E507AFC0ACF95ED391C93CC79E3B3FE37Cn,
                    0x14842F97F263587A164B215DD0F912C588A88DC4AB6AF4C530ADC1226F16E086D62C14435E6BFAB56F019886C88922D2321914EE41A8F746AAA2B964822E4AC6F40EE2492B66824n,
                ],
            },
            x13: {
                q: 0x40000000000000000000292FE77E70C12A4234C33n,
                x: 0x35318FC447D48D7E6BC93B48617DDDEDF26AA658Fn,
                msg0: [
                    0x3B24C5E2C2D935314EABF57A6484289B291ADFE3Fn,
                    0x3D7086A59E6981064A9CDB684653F3A81B6EC0F0Bn,
                    0x3B1E4443443486C7251A68EF184A936F05F8B17C7n,
                    0x2EDF5CFCAC7553C17421FDF54AD1D2EF928A879D2n,
                ],
                msg1: [
                    0x34F46DE59606D56C75406BFB459537A7CC280AA62n,
                    0x38145E3FFCA94E4DDACC20AD6E0997BD0E3B669D2n,
                    0x375813210ECE9C4D7AB42DDC3C55F89189CF6DFFDn,
                    0x25AD8B393BC1E9363600FDA1A2AB6DF40079179A3n,
                ]
            },
            x14: {
                q: 0x1000000000000000000000000000013E974E72F8A6922031D2603CFE0D7n,
                x: 0x07ADC13DD5BF34D1DDEEB50B2CE23B5F5E6D18067306D60C5F6FF11E5D3n,
                msg0: [
                    0x0F2B1C1E80BEB58283AAA79857F7B83BDF724120D0913606FD07F7FFB2Cn,
                    0x034A53897B0BBDB484302E19BF3F9B34A2ABFED639D109A388DC52006B5n,
                    0x04D4670B28990BC92EEB49840B482A1FA03FE028D09F3D21F89C67ECA85n,
                    0x0DE108AAADA760A14F42C057EF81C0A31AF6B82E8FBCA8DC86E443AB549n,
                ],
                msg1: [
                    0x07BDB6A7FD080D9EC2FC84BFF9E3E15750789DC04290C84FED00E109BBDn,
                    0x00376886E89013F7FF4B5214D56A30D49C99F53F211A3AFE01AA2BDE12Dn,
                    0x03726870DE75613C5E529E453F4D92631C03D08A7F63813E497D4CB3877n,
                    0x09CE5810F1AC68810B0DFFBB6BEEF2E0053BB937969AE7886F9D064A8C4n,
                ],
            },
            x15: {
                q: 0x3FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEF90399660FC938A90165B042A7CEFADB307n,
                x: 0x14510D4BC44F2D26F4553942C98073C1BD35545CEABB5CC138853C5158D2729EA408836n,
                msg0: [
                    0x14CC8FCFEECD6B999B4DC6084EBB06FDED0B44D5C507802CC7A5E9ECF36E69DA6AE23C6n,
                    0x38C9D662188982943E080B794A4CFB0732DBA37C6F40D5B8CFADED6FF31C5452BA3F877n,
                    0x21B7265DEBF90E6F988CFFDB62B121A02105226C652807CC324ED6FB119A287A72680ABn,
                    0x20583259DC179D9DA8E5387E89BFF2A3090788CF1496BCABFE7D45BB120B0C811EB8980n,
                ],
                msg1: [
                    0x2E5C1F00677A0E015EC3F799FA9E9A004309DBD784640EAAF5E1CE64D3045B9FE9C1FA1n,
                    0x018A7D44F2B4341FEFE68F6BD8894960F97E08124AAB92C1FFBBE90450FCC9356C9AAA5n,
                    0x3C75397BA4CF1B931877076AF29F2E2F4231B117AB4B8E039F7F9704DE1BD3522F150B6n,
                    0x14E66B18441FA54C21E3492D0611D2B48E19DE3108D915FD5CA08E786327A2675F11074n,
                ],
            },
            x16: {
                q: 0x10000000000000000000000000000000000000000000000000001E2AAD6A612F33307BE5FA47C3C9E052F838164CD37D9A21173n,
                x: 0x0494994CC325B08E7B4CE038BD9436F90B5E59A2C13C3140CD3AE07C04A01FC489F572CE0569A6DB7B8060393DE76330C624177n,
                msg0: [
                    0x0C933F1DC4C70838C2AD16564715ACAF545BCDD8DC203D25AF3EC63949C65CB2E68AC1F60CA7EACA2A823F4E240927AA82CEEC5n,
                    0x08EC42D13A3909A20C41BEBD2DFED8CACCE56C7A7D1251DF43F3E9E289DAE00E239F6960924AC451E125B784CB687C7F23283FDn,
                    0x0DA881BCE3BA851485879EF8AC585A63F1540B9198ECB8A1096D70CB25A104E2F8A96B108AE76CB49CF34491ABC70E9D2AAD450n,
                    0x0750926FFAD7FF5DE85DF7960B3A4F9E3D38CF5A049BFC89739C48D42B34FBEE03D2C047025134CC3145B60AFD22A68DF0A7FB2n,
                ],
                msg1: [
                    0x01ADEB94C19951B460A146B8275D81638C07735B38A525D76023AAF26AA8A058590E1D5B1E78AB3C91608BDA67CFFBE6FC8A6CCn,
                    0x06EBA3D58D0E0DFC406D67FC72EF0C943624CF40019D1E48C3B54CCAB0594AFD5DEE30AEBAA22E693DBCFECAD1A85D774313DADn,
                    0x0A45B787DB44C06DEAB846511EEDBF7BFCFD3BD2C11D965C92FC195F67328F36A2DC83C0352885DAB96B55B02FCF49DCCB0E2DAn,
                    0x0B90F8A0E757E81D4EA6891766729C96A6D01F9AEDC0D334932D1F81CC4E1973A4F01C33555FF08530A5098CADB6EDAE268ABB5n,
                ],
            },
            x17: {
                q: 0x3FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE661CE18FF55987308059B186823851EC7DD9CA1161DE93D5174D66E8382E9BB2FE84E47n,
                x: 0x028A04857F24C1C082DF0D909C0E72F453F2E2340CCB071F0E389BCA2575DA19124198C57174929AD26E348CF63F78D28021EF5A9BF2D5CBEAF6B7CCB6C4DA824DD5C82CFB24E11n,
                msg0: [
                    0x2EAFAD4AC8644DEB29095BBAA88D19F31316434F1766AD4423E0B54DD2FE0C05E307758581B0DAED2902683BBC7C47B00E63E3E429BA54EA6BA3AEC33A94C9A24A6EF8E27B7677An,
                    0x15C2C6B7D1A070274484774E558B69FDFA193BDB7A23F27C2CD24298CE1B22A6CC9B7FB8CABFD6CF7C6B1CF3251E5A1CDDD16FBFED28DE79935BB2C631B8B8EA9CC4BCC937E669En,
                    0x0FEF0B68CB49453A4C6ECBF1708DBEEFC885C57FDAFB88417AAEFA5B1C35017B4B498507937ADCE2F1D9EFFA5FE8F5AEB116B804FD182A6CF1518FDB62D53F60A0FF6EB707D856Bn,
                    0x3FF373833A06C791D7AD586AFA3990F6EF76999C35246C4AD0D519BFF180CA1880E11F2FB38B764854A0AE3BECDDB50F05AC4FCEE542F207C0A6229E2E19652F0E647B9C4882193n,
                ],
                msg1: [
                    0x333C711F8C62F205F926593220233B06228285261D34026232F6F729620C6DE12220F282F4206D223226705608688B20B8BA86D8DFE54F07A37EC48F253283AC33C3F5102C8CC3En,
                    0x328E02CF07C7B5B6D3749D8302F1AE5BFAA8F239398459AF4A2C859C7727A8123A7FE9BE8B228413FC8DC0E9DE16AF3F8F43005107F9989A5D97A5C4455DA895E81336710A3FB2Cn,
                    0x2A77E29EAD9E811A9FDA0284C14CDFA1D9F8FA712DA59D530A06CDE54187E250AD1D4FB5788161938B8DE049616399C5A56B0737C9564C9D4D845A4C6A7CDFCBFF0F01A82BE672En,
                    0x21CE6EE4A2C72C9F93BDB3B552F4A633B8C20C200F894F008643240184BE57BB282A1645E47FBBE131E899B4C61244EFC2486D88CDBD1DD4A65EBDD837019D02628D0DCD6ED8FB5n,
                ],
            }
        }
        for (const v of Object.values(testVectors)) {
            check(v)
        }
    },
    a2s: () => {
        type Result = {
            readonly k: bigint
            readonly r: bigint
            readonly s: bigint
        }
        type H = Array4<Result>
        type P = {
            readonly q: Curve
            readonly x: bigint
            readonly msg0: H
            readonly msg1: H
        }
        type S = { readonly [key: string]: P }
        const check = ({ q, x, msg0, msg1 }: P) => {
            const a = all(q.nf.p)
            const check = (sha: Sha2, { k, r, s }: Result, m: Vec) => {
                const k0 = computeK(a)(sha)(x)(m)
                if (k0 !== k) { throw [k0.toString(16), k.toString(16)] }
                const [r0, s0] = sign(q)(sha)(x)(m)
                if (r0 !== r) { throw [r0, r] }
                if (s0 !== s) { throw [s0, s] }
            }
            const check4 = (m: Vec, h: H) => {
                check(sha224, h[0], m)
                check(sha256, h[1], m)
                check(sha384, h[2], m)
                check(sha512, h[3], m)
            }
            check4(sample, msg0)
            check4(test, msg1)
        }
        const testVectors: S = {
            x3: {
                q: secp192r1,
                x: 0x6FAB034934E4C0FC9AE67F5B5659A9D7D1FEFD187EE09FD4n,
                msg0: [
                    {
                        k: 0x4381526B3FC1E7128F202E194505592F01D5FF4C5AF015D8n,
                        r: 0xA1F00DAD97AEEC91C95585F36200C65F3C01812AA60378F5n,
                        s: 0xE07EC1304C7C6C9DEBBE980B9692668F81D4DE7922A0F97An,
                    },
                    {
                        k: 0x32B1B6D7D42A05CB449065727A84804FB1A3E34D8F261496n,
                        r: 0x4B0B8CE98A92866A2820E20AA6B75B56382E0F9BFD5ECB55n,
                        s: 0xCCDB006926EA9565CBADC840829D8C384E06DE1F1E381B85n,
                    },
                    {
                        k: 0x4730005C4FCB01834C063A7B6760096DBE284B8252EF4311n,
                        r: 0xDA63BF0B9ABCF948FBB1E9167F136145F7A20426DCC287D5n,
                        s: 0xC3AA2C960972BD7A2003A57E1C4C77F0578F8AE95E31EC5En,
                    },
                    {
                        k: 0xA2AC7AB055E4F20692D49209544C203A7D1F2C0BFBC75DB1n,
                        r: 0x4D60C5AB1996BD848343B31C00850205E2EA6922DAC2E4B8n,
                        s: 0x3F6E837448F027A1BF4B34E796E32A811CBB4050908D8F67n,
                    }
                ],
                msg1: [
                    {
                        k: 0xF5DC805F76EF851800700CCE82E7B98D8911B7D510059FBEn,
                        r: 0x6945A1C1D1B2206B8145548F633BB61CEF04891BAF26ED34n,
                        s: 0xB7FB7FDFC339C0B9BD61A9F5A8EAF9BE58FC5CBA2CB15293n,
                    },
                    {
                        k: 0x5C4CE89CF56D9E7C77C8585339B006B97B5F0680B4306C6Cn,
                        r: 0x3A718BD8B4926C3B52EE6BBE67EF79B18CB6EB62B1AD97AEn,
                        s: 0x5662E6848A4A19B1F1AE2F72ACD4B8BBE50F1EAC65D9124Fn,
                    },
                    {
                        k: 0x5AFEFB5D3393261B828DB6C91FBC68C230727B030C975693n,
                        r: 0xB234B60B4DB75A733E19280A7A6034BD6B1EE88AF5332367n,
                        s: 0x7994090B2D59BB782BE57E74A44C9A1C700413F8ABEFE77An,
                    },
                    {
                        k: 0x0758753A5254759C7CFBAD2E2D9B0792EEE44136C9480527n,
                        r: 0xFE4F4AE86A58B6507946715934FE2D8FF9D95B6B098FE739n,
                        s: 0x74CF5605C98FBA0E1EF34D4B5A1577A7DCF59457CAE52290n,
                    }
                ],
            },
            x5: {
                q: secp256r1,
                x: 0xC9AFA9D845BA75166B5C215767B1D6934E50C3DB36E89B127B8A622B120F6721n,
                msg0: [
                    {
                        k: 0x103F90EE9DC52E5E7FB5132B7033C63066D194321491862059967C715985D473n,
                        r: 0x53B2FFF5D1752B2C689DF257C04C40A587FABABB3F6FC2702F1343AF7CA9AA3Fn,
                        s: 0xB9AFB64FDC03DC1A131C7D2386D11E349F070AA432A4ACC918BEA988BF75C74Cn,
                    },
                    {
                        k: 0xA6E3C57DD01ABE90086538398355DD4C3B17AA873382B0F24D6129493D8AAD60n,
                        r: 0xEFD48B2AACB6A8FD1140DD9CD45E81D69D2C877B56AAF991C34D0EA84EAF3716n,
                        s: 0xF7CB1C942D657C41D436C7A1B6E29F65F3E900DBB9AFF4064DC4AB2F843ACDA8n,
                    },
                    {
                        k: 0x09F634B188CEFD98E7EC88B1AA9852D734D0BC272F7D2A47DECC6EBEB375AAD4n,
                        r: 0x0EAFEA039B20E9B42309FB1D89E213057CBF973DC0CFC8F129EDDDC800EF7719n,
                        s: 0x4861F0491E6998B9455193E34E7B0D284DDD7149A74B95B9261F13ABDE940954n,
                    },
                    {
                        k: 0x5FA81C63109BADB88C1F367B47DA606DA28CAD69AA22C4FE6AD7DF73A7173AA5n,
                        r: 0x8496A60B5E9B47C825488827E0495B0E3FA109EC4568FD3F8D1097678EB97F00n,
                        s: 0x2362AB1ADBE2B8ADF9CB9EDAB740EA6049C028114F2460F96554F61FAE3302FEn,
                    }
                ],
                msg1: [
                    {
                        k: 0x669F4426F2688B8BE0DB3A6BD1989BDAEFFF84B649EEB84F3DD26080F667FAA7n,
                        r: 0xC37EDB6F0AE79D47C3C27E962FA269BB4F441770357E114EE511F662EC34A692n,
                        s: 0xC820053A05791E521FCAAD6042D40AEA1D6B1A540138558F47D0719800E18F2Dn,
                    },
                    {
                        k: 0xD16B6AE827F17175E040871A1C7EC3500192C4C92677336EC2537ACAEE0008E0n,
                        r: 0xF1ABB023518351CD71D881567B1EA663ED3EFCF6C5132B354F28D3B0B7D38367n,
                        s: 0x019F4113742A2B14BD25926B49C649155F267E60D3814B4C0CC84250E46F0083n,
                    },
                    {
                        k: 0x16AEFFA357260B04B1DD199693960740066C1A8F3E8EDD79070AA914D361B3B8n,
                        r: 0x83910E8B48BB0C74244EBDF7F07A1C5413D61472BD941EF3920E623FBCCEBEB6n,
                        s: 0x8DDBEC54CF8CD5874883841D712142A56A8D0F218F5003CB0296B6B509619F2Cn,
                    },
                    {
                        k: 0x6915D11632ACA3C40D5D51C08DAF9C555933819548784480E93499000D9F0B7Fn,
                        r: 0x461D93F31B6540894788FD206C07CFA0CC35F46FA3C91816FFF1040AD1581A04n,
                        s: 0x39AF9F15DE0DB8D97E72719C74820D304CE5226E32DEDAE67519E840D1194E55n,
                    },
                ],
            },
            x6: {
                q: secp384r1,
                x: 0x6B9D3DAD2E1B8C1C05B19875B6659F4DE23C3B667BF297BA9AA47740787137D896D5724E4C70A825F872C9EA60D2EDF5n,
                msg0: [
                    {
                        k: 0xA4E4D2F0E729EB786B31FC20AD5D849E304450E0AE8E3E341134A5C1AFA03CAB8083EE4E3C45B06A5899EA56C51B5879n,
                        r: 0x42356E76B55A6D9B4631C865445DBE54E056D3B3431766D0509244793C3F9366450F76EE3DE43F5A125333A6BE060122n,
                        s: 0x9DA0C81787064021E78DF658F2FBB0B042BF304665DB721F077A4298B095E4834C082C03D83028EFBF93A3C23940CA8Dn,
                    },
                    {
                        k: 0x180AE9F9AEC5438A44BC159A1FCB277C7BE54FA20E7CF404B490650A8ACC414E375572342863C899F9F2EDF9747A9B60n,
                        r: 0x21B13D1E013C7FA1392D03C5F99AF8B30C570C6F98D4EA8E354B63A21D3DAA33BDE1E888E63355D92FA2B3C36D8FB2CDn,
                        s: 0xF3AA443FB107745BF4BD77CB3891674632068A10CA67E3D45DB2266FA7D1FEEBEFDC63ECCD1AC42EC0CB8668A4FA0AB0n,
                    },
                    {
                        k: 0x94ED910D1A099DAD3254E9242AE85ABDE4BA15168EAF0CA87A555FD56D10FBCA2907E3E83BA95368623B8C4686915CF9n,
                        r: 0x94EDBB92A5ECB8AAD4736E56C691916B3F88140666CE9FA73D64C4EA95AD133C81A648152E44ACF96E36DD1E80FABE46n,
                        s: 0x99EF4AEB15F178CEA1FE40DB2603138F130E740A19624526203B6351D0A3A94FA329C145786E679E7B82C71A38628AC8n,
                    },
                    {
                        k: 0x92FC3C7183A883E24216D1141F1A8976C5B0DD797DFA597E3D7B32198BD35331A4E966532593A52980D0E3AAA5E10EC3n,
                        r: 0xED0959D5880AB2D869AE7F6C2915C6D60F96507F9CB3E047C0046861DA4A799CFE30F35CC900056D7C99CD7882433709n,
                        s: 0x512C8CCEEE3890A84058CE1E22DBC2198F42323CE8ACA9135329F03C068E5112DC7CC3EF3446DEFCEB01A45C2667FDD5n,
                    }
                ],
                msg1: [
                    {
                        k: 0x18FA39DB95AA5F561F30FA3591DC59C0FA3653A80DAFFA0B48D1A4C6DFCBFF6E3D33BE4DC5EB8886A8ECD093F2935726n,
                        r: 0xE8C9D0B6EA72A0E7837FEA1D14A1A9557F29FAA45D3E7EE888FC5BF954B5E62464A9A817C47FF78B8C11066B24080E72n,
                        s: 0x07041D4A7A0379AC7232FF72E6F77B6DDB8F09B16CCE0EC3286B2BD43FA8C6141C53EA5ABEF0D8231077A04540A96B66n,
                    },
                    {
                        k: 0x0CFAC37587532347DC3389FDC98286BBA8C73807285B184C83E62E26C401C0FAA48DD070BA79921A3457ABFF2D630AD7n,
                        r: 0x6D6DEFAC9AB64DABAFE36C6BF510352A4CC27001263638E5B16D9BB51D451559F918EEDAF2293BE5B475CC8F0188636Bn,
                        s: 0x2D46F3BECBCC523D5F1A1256BF0C9B024D879BA9E838144C8BA6BAEB4B53B47D51AB373F9845C0514EEFB14024787265n,
                    },
                    {
                        k: 0x015EE46A5BF88773ED9123A5AB0807962D193719503C527B031B4C2D225092ADA71F4A459BC0DA98ADB95837DB8312EAn,
                        r: 0x8203B63D3C853E8D77227FB377BCF7B7B772E97892A80F36AB775D509D7A5FEB0542A7F0812998DA8F1DD3CA3CF023DBn,
                        s: 0xDDD0760448D42D8A43AF45AF836FCE4DE8BE06B485E9B61B827C2F13173923E06A739F040649A667BF3B828246BAA5A5n,
                    },
                    {
                        k: 0x3780C4F67CB15518B6ACAE34C9F83568D2E12E47DEAB6C50A4E4EE5319D1E8CE0E2CC8A136036DC4B9C00E6888F66B6Cn,
                        r: 0xA0D5D090C9980FAF3C2CE57B7AE951D31977DD11C775D314AF55F76C676447D06FB6495CD21B4B6E340FC236584FB277n,
                        s: 0x976984E59B4C77B0E8E4460DCA3D9F20E07B9BB1F63BEEFAF576F6B2E8B224634A2092CD3792E0159AD9CEE37659C736n,
                    }
                ],
            },
            x7: {
                q: secp521r1,
                x: 0x0FAD06DAA62BA3B25D2FB40133DA757205DE67F5BB0018FEE8C86E1B68C7E75CAA896EB32F1F47C70855836A6D16FCC1466F6D8FBEC67DB89EC0C08B0E996B83538n,
                msg0: [
                    {
                        k: 0x121415EC2CD7726330A61F7F3FA5DE14BE9436019C4DB8CB4041F3B54CF31BE0493EE3F427FB906393D895A19C9523F3A1D54BB8702BD4AA9C99DAB2597B92113F3n,
                        r: 0x1776331CFCDF927D666E032E00CF776187BC9FDD8E69D0DABB4109FFE1B5E2A30715F4CC923A4A5E94D2503E9ACFED92857B7F31D7152E0F8C00C15FF3D87E2ED2En,
                        s: 0x050CB5265417FE2320BBB5A122B8E1A32BD699089851128E360E620A30C7E17BA41A666AF126CE100E5799B153B60528D5300D08489CA9178FB610A2006C254B41Fn,
                    },
                    {
                        k: 0x0EDF38AFCAAECAB4383358B34D67C9F2216C8382AAEA44A3DAD5FDC9C32575761793FEF24EB0FC276DFC4F6E3EC476752F043CF01415387470BCBD8678ED2C7E1A0n,
                        r: 0x1511BB4D675114FE266FC4372B87682BAECC01D3CC62CF2303C92B3526012659D16876E25C7C1E57648F23B73564D67F61C6F14D527D54972810421E7D87589E1A7n,
                        s: 0x04A171143A83163D6DF460AAF61522695F207A58B95C0644D87E52AA1A347916E4F7A72930B1BC06DBE22CE3F58264AFD23704CBB63B29B931F7DE6C9D949A7ECFCn,
                    },
                    {
                        k: 0x1546A108BC23A15D6F21872F7DED661FA8431DDBD922D0DCDB77CC878C8553FFAD064C95A920A750AC9137E527390D2D92F153E66196966EA554D9ADFCB109C4211n,
                        r: 0x1EA842A0E17D2DE4F92C15315C63DDF72685C18195C2BB95E572B9C5136CA4B4B576AD712A52BE9730627D16054BA40CC0B8D3FF035B12AE75168397F5D50C67451n,
                        s: 0x1F21A3CEE066E1961025FB048BD5FE2B7924D0CD797BABE0A83B66F1E35EEAF5FDE143FA85DC394A7DEE766523393784484BDF3E00114A1C857CDE1AA203DB65D61n,
                    },
                    {
                        k: 0x1DAE2EA071F8110DC26882D4D5EAE0621A3256FC8847FB9022E2B7D28E6F10198B1574FDD03A9053C08A1854A168AA5A57470EC97DD5CE090124EF52A2F7ECBFFD3n,
                        r: 0x0C328FAFCBD79DD77850370C46325D987CB525569FB63C5D3BC53950E6D4C5F174E25A1EE9017B5D450606ADD152B534931D7D4E8455CC91F9B15BF05EC36E377FAn,
                        s: 0x0617CCE7CF5064806C467F678D3B4080D6F1CC50AF26CA209417308281B68AF282623EAA63E5B5C0723D8B8C37FF0777B1A20F8CCB1DCCC43997F1EE0E44DA4A67An,
                    }
                ],
                msg1: [
                    {
                        k: 0x040D09FCF3C8A5F62CF4FB223CBBB2B9937F6B0577C27020A99602C25A01136987E452988781484EDBBCF1C47E554E7FC901BC3085E5206D9F619CFF07E73D6F706n,
                        r: 0x1C7ED902E123E6815546065A2C4AF977B22AA8EADDB68B2C1110E7EA44D42086BFE4A34B67DDC0E17E96536E358219B23A706C6A6E16BA77B65E1C595D43CAE17FBn,
                        s: 0x177336676304FCB343CE028B38E7B4FBA76C1C1B277DA18CAD2A8478B2A9A9F5BEC0F3BA04F35DB3E4263569EC6AADE8C92746E4C82F8299AE1B8F1739F8FD519A4n,
                    },
                    {
                        k: 0x01DE74955EFAABC4C4F17F8E84D881D1310B5392D7700275F82F145C61E843841AF09035BF7A6210F5A431A6A9E81C9323354A9E69135D44EBD2FCAA7731B909258n,
                        r: 0x00E871C4A14F993C6C7369501900C4BC1E9C7B0B4BA44E04868B30B41D8071042EB28C4C250411D0CE08CD197E4188EA4876F279F90B3D8D74A3C76E6F1E4656AA8n,
                        s: 0x0CD52DBAA33B063C3A6CD8058A1FB0A46A4754B034FCC644766CA14DA8CA5CA9FDE00E88C1AD60CCBA759025299079D7A427EC3CC5B619BFBC828E7769BCD694E86n,
                    },
                    {
                        k: 0x1F1FC4A349A7DA9A9E116BFDD055DC08E78252FF8E23AC276AC88B1770AE0B5DCEB1ED14A4916B769A523CE1E90BA22846AF11DF8B300C38818F713DADD85DE0C88n,
                        r: 0x14BEE21A18B6D8B3C93FAB08D43E739707953244FDBE924FA926D76669E7AC8C89DF62ED8975C2D8397A65A49DCC09F6B0AC62272741924D479354D74FF6075578Cn,
                        s: 0x133330865C067A0EAF72362A65E2D7BC4E461E8C8995C3B6226A21BD1AA78F0ED94FE536A0DCA35534F0CD1510C41525D163FE9D74D134881E35141ED5E8E95B979n,
                    },
                    {
                        k: 0x16200813020EC986863BEDFC1B121F605C1215645018AEA1A7B215A564DE9EB1B38A67AA1128B80CE391C4FB71187654AAA3431027BFC7F395766CA988C964DC56Dn,
                        r: 0x13E99020ABF5CEE7525D16B69B229652AB6BDF2AFFCAEF38773B4B7D08725F10CDB93482FDCC54EDCEE91ECA4166B2A7C6265EF0CE2BD7051B7CEF945BABD47EE6Dn,
                        s: 0x1FBD0013C674AA79CB39849527916CE301C66EA7CE8B80682786AD60F98F7E78A19CA69EFF5C57400E3B3A0AD66CE0978214D13BAF4E9AC60752F7B155E2DE4DCE3n,
                    },
                ]
            },
        }
        for (const v of Object.values(testVectors)) {
            check(v)
        }
    }
}
